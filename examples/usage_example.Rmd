---
title: "Usage Examples"
author: "Nick R. Bachelder"
date: "2023-01-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(gridExtra)
library(tidycensus)
library(acs)
library(dplyr)
library(leaflet)
library(rgdal)
library(sp)
library(sf)
library(dplyr)
library(ggplot2)
library(shiny)
library(DT)
library(ggrepel)
library(tidyr)
library(shinycssloaders)
library(shinythemes)
library(SwimmeR)
library(lubridate)
library(maptools)
library(readr)
library(rgeos)
library(readxl)
library(here)
library(viridis)
library(reshape2)
library(here)
setwd(here::here())

source(paste0(here::here(), '/functions/ses_pull_functions.R'))
source(paste0(here::here(), '/functions/ses_plot_functions.R'))
```


# Run census api key to pull (NOTE: only need to do this once).

In order to obtain a tidycensus key, visit http://api.census.gov/data/key_signup.html
```{r}
# census_api_key("INSERT CODE HERE",
#                overwrite=T, install=T)
```

# Specify Needed Years and Codes

Possible values for geo: county ("county"), zip code ("zcta"), many more found at https://walker-data.com/tidycensus/articles/basic-usage.html

As a general note, zcta maps take much longer as shapefiles are much more detailed than county (~500mb v ~75mb).

```{r}
needed_years <- seq(2011, 2013, by = 1)
geo <- "zcta"
```


# Pull SES data

Possible years are dependent on geographical input: For zcta (2011 - 2021), for county (2009 - 2021).

After running this line, variables removed due to incompleteness for any of the years (ie. variables not taken during year x) are listed.

This code chunk may take a few minutes, dependent on how many years of data are being pulled.
```{r}
# get codes from excel file found in codes_data folder
my_codes <- get_existing_codes(years = needed_years, file_path = paste0(here::here(), '/codes_data/acs_2014_codes_updated.csv')) 

# pull data
dat_all <- get_multiple_ACS(years = needed_years, codes = my_codes, geo = geo)
```

```{r}
# complete cleaning on variables selected (this will vary by variables selected)

num_occupants_1.01_up_all <- dat_all %>%
    dplyr::select(num_occupants_1.01_1.5_owned, num_occupants_1.51_2_owned,
           num_occupants_2.1_up_owned, num_occupants_1.01_1.5_rented,
           num_occupants_1.51_2_rented, num_occupants_2.1_up_rented) %>%
    rowSums()
  dat_all <- dat_all %>%
    mutate(num_occupants_crowded = num_occupants_1.01_up_all)
  
  phone_service_rented_owned <- dat_all %>%
    dplyr::select(phone_service_owned, phone_service_rented) %>%
    rowSums()
  
  dat_all <- dat_all %>%
    mutate(phone_service = phone_service_rented_owned)
  
  dat_all <- data.frame(dat_all) %>% 
    mutate(population = male_total,
           male_prop = male/male_total, # sex covariate
           # race covariates
           white_prop = white / white_total,
           pop_non_hispanic_black_prop = pop_non_hispanic_black/pop_total,
           hispanic_prop = hispanic / hispanic_total,
           # age covariates
           # 
           age_under_5_prop = (male_under_5 + 
                                 female_under_5) / (female_total + male_total),
           age_5_17_prop = (male_5_9 + 
                              male_10_14 + 
                              male_15_17 +
                              female_5_9 + 
                              female_10_14 + 
                              female_15_17) / (male_total + female_total),
           age_18_39_prop = (male_18_19 +
                               male_20 +
                               male_21 +
                               male_22_24 +
                               male_25_29 +
                               male_30_34 +
                               male_35_39 +
                               female_18_19 +
                               female_20 +
                               female_21 +
                               female_22_24 +
                               female_25_29 +
                               female_30_34 +
                               female_35_39) / (male_total + female_total),
           age_40_64_prop = (male_40_44 + 
                               male_45_49 + 
                               male_50_54 + 
                               male_55_59 + 
                               male_60_61 + 
                               male_62_64 + 
                               female_40_44 + 
                               female_45_49 + 
                               female_50_54 + 
                               female_55_59 + 
                               female_60_61 + 
                               female_62_64) / (male_total + female_total),
           age_over_65_prop = (male_65_66 + 
                                 male_67_69 + 
                                 male_70_74 + 
                                 male_75_79 + 
                                 male_80_84 + 
                                 male_85_over + 
                                 female_65_66 + 
                                 female_67_69 + 
                                 female_70_74 + 
                                 female_75_79 + 
                                 female_80_84 + 
                                 female_85_over) / (male_total + female_total),
           # SES variables
           poverty_prop = below_poverty_line/poverty_total,
           family_type_female_householder_prop = family_type_female_householder/family_type_total,
           family_type_single_prop = family_type_single/family_type_total,
           housing_rental_prop = housing_rental/housing_total,
           crowded_prop = num_occupants_crowded/num_occupants_total,
           phone_service_prop = phone_service/phone_service_total,
           public_assistance_prop = public_assistance/public_assistance_total) %>%
    dplyr::select(GEOID, population, StateAb, year, ends_with("prop"), geo) %>%
    ungroup()
  
dat_all
```


# Mapping

Run the below line to download and clean shape plots (NOTE: only need to do this once).

This may take a few minutes.

```{r}
# source(paste0(here::here(), '/shape_pull/shape_pull.R'))
```

Note plotting can only be done with geographies "zcta", or "county".

Below pulls in appropriate shape plot. You should include this in all scripts.

```{r}
if (geo == "zcta"){
  shape <- readOGR(here::here('shape_pull/zcta_shape'), layer = 'zcta')
}
if (geo == "county"){
  shape <- readOGR(here::here('shape_pull/county_shape'), layer = 'county')
}
```

# Leaflet State Plot Example
```{r}
# Also Try: States = "All'
# You can drag below
get_leaflet(dat_all = dat_all, states = 'All', years ="2011", attribute = 'age_over_65_prop', geo = geo)
```


# State ggplot Example
```{r}
get_geom_poly(dat_all = dat_all, states = 'PA', years = '2013', attribute = 'age_over_65_prop', geo = geo)
```

# State ggplot Progression Example
```{r}
see_year_progression(dat_all = dat_all, states = 'PA', attribute = 'age_over_65_prop', geo = geo, years = needed_years)
```


# Adding New Variables

Run below line if you want to see all possible census variables (1045 topics, some seperated by age, etc). Previously used variables are found and used in the data_codes folder, but more can be added (Note: if you would like to do this, more cleaning may be neccecary in the pull function)

```{r}
# load_variables(2015, "acs5", cache = TRUE)$concept %>% unique()
```











